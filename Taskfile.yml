version: "3"

vars:
  VERSION: '{{.VERSION | default "dev"}}'
  BUILD_TIME:
    sh: date -u '+%Y-%m-%d %H:%M:%S UTC'
  COVERAGE_THRESHOLD: 50

tasks:
  # === ä¾èµ–ç®¡ç† ===
  deps:
    desc: ä¸‹è½½ä¾èµ–
    cmds:
      - go mod download

  tidy:
    desc: æ•´ç†ä¾èµ–
    cmds:
      - go mod tidy

  deps-check:
    desc: æ£€æŸ¥ä¾èµ–æ˜¯å¦éœ€è¦æ›´æ–°
    silent: true
    cmds:
      - go mod tidy
      - |
        if ! git diff --exit-code go.mod go.sum >/dev/null 2>&1; then
          echo "âŒ go.mod æˆ– go.sum æ–‡ä»¶éœ€è¦æ›´æ–°"
          echo "è¯·è¿è¡Œ: task tidy"
          exit 1
        else
          echo "âœ… ä¾èµ–æ–‡ä»¶æ˜¯æœ€æ–°çš„"
        fi

  # === ä»£ç è´¨é‡æ£€æŸ¥ ===
  vet:
    desc: è¿è¡Œ Go vet é™æ€åˆ†æ
    cmds:
      - go vet ./...

  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - go fmt ./...

  fmt-check:
    desc: æ£€æŸ¥ä»£ç æ ¼å¼
    silent: true
    cmds:
      - |
        unformatted=$(gofmt -l .)
        if [ -n "$unformatted" ]; then
          echo "âŒ ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
          echo "$unformatted"
          echo "è¯·è¿è¡Œ: task fmt"
          exit 1
        else
          echo "âœ… ä»£ç æ ¼å¼æ­£ç¡®"
        fi

  # === æµ‹è¯•ç›¸å…³ ===
  test:
    desc: è¿è¡Œå•å…ƒæµ‹è¯•
    cmds:
      - go test -v ./...

  test-race:
    desc: è¿è¡Œå•å…ƒæµ‹è¯• (å¸¦ç«æ€æ£€æµ‹)
    cmds:
      - go test -v -race ./...

  test-coverage:
    desc: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    cmds:
      - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      - go tool cover -html=coverage.out -o coverage.html
      - |
        COVERAGE=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}' | sed 's/%//')
        echo "å½“å‰æµ‹è¯•è¦†ç›–ç‡: ${COVERAGE}%"

        if (( $(echo "$COVERAGE < {{.COVERAGE_THRESHOLD}}" | bc -l) )); then
          echo "âŒ æµ‹è¯•è¦†ç›–ç‡ ${COVERAGE}% ä½äºè¦æ±‚çš„ {{.COVERAGE_THRESHOLD}}%"
          exit 1
        else
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡ ${COVERAGE}% è¾¾åˆ°è¦æ±‚"
        fi

  test-short:
    desc: è¿è¡Œå¿«é€Ÿæµ‹è¯• (è·³è¿‡é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•)
    cmds:
      - go test -v -short ./...

  # === æ„å»ºç›¸å…³ ===
  build:
    desc: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ (é™æ€é“¾æ¥)
    cmds:
      - CGO_ENABLED=0 go build -trimpath -ldflags "-s -w -X main.version={{.VERSION}} -X 'main.buildTime={{.BUILD_TIME}}'" -o hwcctl .

  build-goreleaser:
    desc: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ (ä½¿ç”¨ GoReleaser)
    cmds:
      - goreleaser build --single-target --snapshot --clean

  build-with-version:
    desc: æ„å»ºå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„äºŒè¿›åˆ¶æ–‡ä»¶ (ä½¿ç”¨ GoReleaser)
    cmds:
      - goreleaser build --single-target --snapshot --clean

  build-release:
    desc: æ„å»ºå‘å¸ƒåŒ… (å¤šå¹³å°ï¼Œä½¿ç”¨ GoReleaser)
    cmds:
      - goreleaser build --clean

  # === CI/CD ä»»åŠ¡ ===
  ci-quality:
    desc: CI ä»£ç è´¨é‡æ£€æŸ¥ (åŒ…å«æ‰€æœ‰æ£€æŸ¥é¡¹)
    deps: [deps]
    cmds:
      - task: deps-check
      - task: fmt-check
      - task: vet
      - task: test-coverage
      - task: build

  # === è¿è¡Œç›¸å…³ ===
  run:
    desc: è¿è¡Œä¸»ç¨‹åº
    cmds:
      - go run main.go

  run-help:
    desc: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    cmds:
      - go run main.go --help

  run-version:
    desc: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    cmds:
      - go run main.go version

  # === æ¸…ç†ç›¸å…³ ===
  clean:
    desc: æ¸…ç†æ„å»ºäº§ç‰©
    cmds:
      - rm -f hwcctl
      - rm -f coverage.out coverage.html
      - rm -rf dist/

  clean-all:
    desc: æ¸…ç†æ‰€æœ‰äº§ç‰©
    deps: [clean]
    cmds:
      - go clean -cache
      - go clean -modcache

  # === å‘å¸ƒç›¸å…³ ===
  release:
    desc: å‘å¸ƒç‰ˆæœ¬ (éœ€è¦ Git æ ‡ç­¾)
    cmds:
      - goreleaser release --clean

  release-snapshot:
    desc: æ„å»ºå¿«ç…§ç‰ˆæœ¬ (æœ¬åœ°æµ‹è¯•ç”¨)
    cmds:
      - goreleaser release --snapshot --clean
      - echo "æ„å»ºäº§ç‰©åœ¨ dist/ ç›®å½•ä¸­"

  release-check:
    desc: æ£€æŸ¥ GoReleaser é…ç½®
    cmds:
      - goreleaser check

  # === Git Hooks ç®¡ç† ===
  install-hooks:
    desc: å®‰è£… Git hooks (pre-commit)
    cmds:
      - |
        echo "ğŸ”§ å®‰è£… Git pre-commit hook..."
        if [ -f .git/hooks/pre-commit ]; then
          echo "âœ… pre-commit hook å·²å­˜åœ¨"
        else
          echo "âŒ pre-commit hook ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"
          exit 1
        fi
        chmod +x .git/hooks/pre-commit
        echo "âœ… Git hooks å®‰è£…å®Œæˆ"
        echo "ğŸ“ ç°åœ¨æ¯æ¬¡ git commit å‰ä¼šè‡ªåŠ¨ï¼š"
        echo "   - æ ¼å¼åŒ– Go ä»£ç  (task fmt)"
        echo "   - æ£€æŸ¥ä»£ç æ ¼å¼ (task fmt-check)"  
        echo "   - è¿è¡Œé™æ€åˆ†æ (task vet)"
        echo "   - æ£€æŸ¥ä¾èµ–çŠ¶æ€ (task deps-check)"

  uninstall-hooks:
    desc: å¸è½½ Git hooks
    cmds:
      - |
        echo "ğŸ—‘ï¸  å¸è½½ Git hooks..."
        if [ -f .git/hooks/pre-commit ]; then
          rm .git/hooks/pre-commit
          echo "âœ… pre-commit hook å·²åˆ é™¤"
        else
          echo "â„¹ï¸  pre-commit hook ä¸å­˜åœ¨"
        fi

  test-hooks:
    desc: æµ‹è¯• Git hooks åŠŸèƒ½
    cmds:
      - |
        echo "ğŸ§ª æµ‹è¯• pre-commit hook..."
        if [ -x .git/hooks/pre-commit ]; then
          echo "âœ… pre-commit hook å­˜åœ¨ä¸”å¯æ‰§è¡Œ"
          echo "ğŸ“‹ hook å†…å®¹é¢„è§ˆ:"
          head -10 .git/hooks/pre-commit
        else
          echo "âŒ pre-commit hook ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ"
          echo "è¯·è¿è¡Œ: task install-hooks"
        fi

  # === å¼€å‘å·¥å…· ===
  dev-setup:
    desc: è®¾ç½®å¼€å‘ç¯å¢ƒ
    cmds:
      - task: deps
      - task: install-hooks
      - echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

  dev-test:
    desc: å¼€å‘æ—¶å¿«é€Ÿæµ‹è¯•
    cmds:
      - task: fmt
      - task: vet
      - task: test

  dev-build:
    desc: å¼€å‘æ—¶æ„å»ºæµ‹è¯•
    cmds:
      - task: build
      - echo "âœ… æ„å»ºå®Œæˆï¼Œå¯æ‰§è¡Œæ–‡ä»¶åœ¨ dist/ ç›®å½•"
