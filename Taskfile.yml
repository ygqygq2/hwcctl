version: "3"

vars:
  VERSION: '{{.VERSION | default "dev"}}'
  BUILD_TIME:
    sh: date -u '+%Y-%m-%d %H:%M:%S UTC'
  COVERAGE_THRESHOLD: 50

tasks:
  # === ä¾èµ–ç®¡ç† ===
  deps:
    desc: ä¸‹è½½ä¾èµ–
    cmds:
      - go mod download

  tidy:
    desc: æ•´ç†ä¾èµ–
    cmds:
      - go mod tidy

  deps-check:
    desc: æ£€æŸ¥ä¾èµ–æ˜¯å¦éœ€è¦æ›´æ–°
    silent: true
    cmds:
      - go mod tidy
      - |
        if ! git diff --exit-code go.mod go.sum >/dev/null 2>&1; then
          echo "âŒ go.mod æˆ– go.sum æ–‡ä»¶éœ€è¦æ›´æ–°"
          echo "è¯·è¿è¡Œ: task tidy"
          exit 1
        else
          echo "âœ… ä¾èµ–æ–‡ä»¶æ˜¯æœ€æ–°çš„"
        fi

  # === ä»£ç è´¨é‡æ£€æŸ¥ ===
  vet:
    desc: è¿è¡Œ Go vet é™æ€åˆ†æ
    cmds:
      - go vet ./...

  fmt:
    desc: æ ¼å¼åŒ–ä»£ç 
    cmds:
      - go fmt ./...

  fmt-check:
    desc: æ£€æŸ¥ä»£ç æ ¼å¼
    silent: true
    cmds:
      - |
        unformatted=$(gofmt -l .)
        if [ -n "$unformatted" ]; then
          echo "âŒ ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
          echo "$unformatted"
          echo "è¯·è¿è¡Œ: task fmt"
          exit 1
        else
          echo "âœ… ä»£ç æ ¼å¼æ­£ç¡®"
        fi

  # === æµ‹è¯•ç›¸å…³ ===
  test:
    desc: è¿è¡Œå•å…ƒæµ‹è¯•
    cmds:
      - go test -v ./...

  test-race:
    desc: è¿è¡Œå•å…ƒæµ‹è¯• (å¸¦ç«æ€æ£€æµ‹)
    cmds:
      - go test -v -race ./...

  test-coverage:
    desc: è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    cmds:
      - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
      - go tool cover -html=coverage.out -o coverage.html
      - |
        COVERAGE=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}' | sed 's/%//')
        echo "å½“å‰æµ‹è¯•è¦†ç›–ç‡: ${COVERAGE}%"

        if (( $(echo "$COVERAGE < {{.COVERAGE_THRESHOLD}}" | bc -l) )); then
          echo "âŒ æµ‹è¯•è¦†ç›–ç‡ ${COVERAGE}% ä½äºè¦æ±‚çš„ {{.COVERAGE_THRESHOLD}}%"
          exit 1
        else
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡ ${COVERAGE}% è¾¾åˆ°è¦æ±‚"
        fi

  test-short:
    desc: è¿è¡Œå¿«é€Ÿæµ‹è¯• (è·³è¿‡é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•)
    cmds:
      - go test -v -short ./...

  # === æ„å»ºç›¸å…³ (ç»Ÿä¸€ä½¿ç”¨ GoReleaserï¼Œç¡®ä¿é™æ€ç¼–è¯‘) ===
  build:
    desc: æ„å»ºå½“å‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶ (é™æ€ç¼–è¯‘)
    cmds:
      - goreleaser build --single-target --snapshot --clean
      - echo "âœ… é™æ€ç¼–è¯‘å®Œæˆ (CGO_ENABLED=0)"

  build-all:
    desc: æ„å»ºæ‰€æœ‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶ (é™æ€ç¼–è¯‘)
    cmds:
      - goreleaser build --clean
      - echo "âœ… å¤šå¹³å°é™æ€ç¼–è¯‘å®Œæˆ"

  build-debug:
    desc: æ„å»ºå½“å‰å¹³å°äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¿ç•™è°ƒè¯•ä¿¡æ¯
    cmds:
      - goreleaser build --single-target --snapshot --clean --config .goreleaser-debug.yaml
      - echo "âœ… è°ƒè¯•ç‰ˆæœ¬ç¼–è¯‘å®Œæˆ"

  # === CI/CD ä»»åŠ¡ ===
  ci-quality:
    desc: CI ä»£ç è´¨é‡æ£€æŸ¥ (åŒ…å«æ‰€æœ‰æ£€æŸ¥é¡¹ï¼Œä½¿ç”¨é™æ€ç¼–è¯‘)
    deps: [deps]
    cmds:
      - task: deps-check
      - task: fmt-check
      - task: vet
      - task: test-coverage
      - task: build
      - echo "âœ… CI è´¨é‡æ£€æŸ¥å®Œæˆï¼Œæ‰€æœ‰æ„å»ºéƒ½ä½¿ç”¨é™æ€ç¼–è¯‘"

  # === è¿è¡Œç›¸å…³ ===
  run:
    desc: è¿è¡Œä¸»ç¨‹åº
    cmds:
      - go run main.go

  run-help:
    desc: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
    cmds:
      - go run main.go --help

  run-version:
    desc: æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
    cmds:
      - go run main.go version

  # === æ¸…ç†ç›¸å…³ ===
  clean:
    desc: æ¸…ç†æ„å»ºäº§ç‰©
    cmds:
      - rm -f hwcctl
      - rm -f coverage.out coverage.html
      - rm -rf dist/

  clean-all:
    desc: æ¸…ç†æ‰€æœ‰äº§ç‰©
    deps: [clean]
    cmds:
      - go clean -cache
      - go clean -modcache

  # === å‘å¸ƒç›¸å…³ (ä½¿ç”¨ GoReleaser é™æ€ç¼–è¯‘) ===
  release:
    desc: å‘å¸ƒç‰ˆæœ¬åˆ° GitHub (éœ€è¦ Git æ ‡ç­¾ï¼Œé™æ€ç¼–è¯‘)
    deps: [deps-check, fmt-check, vet, test-coverage]
    cmds:
      - goreleaser release --clean
      - echo "âœ… å‘å¸ƒå®Œæˆï¼Œæ‰€æœ‰å¹³å°éƒ½ä½¿ç”¨é™æ€ç¼–è¯‘ (CGO_ENABLED=0)"

  release-snapshot:
    desc: æ„å»ºå¿«ç…§ç‰ˆæœ¬ (æœ¬åœ°æµ‹è¯•ç”¨ï¼Œé™æ€ç¼–è¯‘)
    deps: [deps-check, fmt-check, vet]
    cmds:
      - goreleaser release --snapshot --clean
      - echo "âœ… å¿«ç…§ç‰ˆæœ¬æ„å»ºå®Œæˆï¼Œäº§ç‰©åœ¨ dist/ ç›®å½•ä¸­"
      - echo "ğŸ“ æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½æ˜¯é™æ€ç¼–è¯‘çš„ (CGO_ENABLED=0)"
      - ls -la dist/

  release-check:
    desc: æ£€æŸ¥ GoReleaser é…ç½®å’Œæ„å»ºè®¾ç½®
    cmds:
      - goreleaser check
      - echo "âœ… GoReleaser é…ç½®æ£€æŸ¥é€šè¿‡"
      - echo "ğŸ“‹ æ„å»ºé…ç½®æ‘˜è¦:"
      - grep -A 15 "builds:" .goreleaser.yaml

  # === Git Hooks ç®¡ç† ===
  install-hooks:
    desc: å®‰è£… Git hooks (pre-commit)
    cmds:
      - |
        echo "ğŸ”§ å®‰è£… Git pre-commit hook..."
        if [ -f .git/hooks/pre-commit ]; then
          echo "âœ… pre-commit hook å·²å­˜åœ¨"
        else
          echo "âŒ pre-commit hook ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"
          exit 1
        fi
        chmod +x .git/hooks/pre-commit
        echo "âœ… Git hooks å®‰è£…å®Œæˆ"
        echo "ğŸ“ ç°åœ¨æ¯æ¬¡ git commit å‰ä¼šè‡ªåŠ¨ï¼š"
        echo "   - æ ¼å¼åŒ– Go ä»£ç  (task fmt)"
        echo "   - æ£€æŸ¥ä»£ç æ ¼å¼ (task fmt-check)"  
        echo "   - è¿è¡Œé™æ€åˆ†æ (task vet)"
        echo "   - æ£€æŸ¥ä¾èµ–çŠ¶æ€ (task deps-check)"

  uninstall-hooks:
    desc: å¸è½½ Git hooks
    cmds:
      - |
        echo "ğŸ—‘ï¸  å¸è½½ Git hooks..."
        if [ -f .git/hooks/pre-commit ]; then
          rm .git/hooks/pre-commit
          echo "âœ… pre-commit hook å·²åˆ é™¤"
        else
          echo "â„¹ï¸  pre-commit hook ä¸å­˜åœ¨"
        fi

  test-hooks:
    desc: æµ‹è¯• Git hooks åŠŸèƒ½
    cmds:
      - |
        echo "ğŸ§ª æµ‹è¯• pre-commit hook..."
        if [ -x .git/hooks/pre-commit ]; then
          echo "âœ… pre-commit hook å­˜åœ¨ä¸”å¯æ‰§è¡Œ"
          echo "ğŸ“‹ hook å†…å®¹é¢„è§ˆ:"
          head -10 .git/hooks/pre-commit
        else
          echo "âŒ pre-commit hook ä¸å­˜åœ¨æˆ–ä¸å¯æ‰§è¡Œ"
          echo "è¯·è¿è¡Œ: task install-hooks"
        fi

  # === å¼€å‘å·¥å…· ===
  dev-setup:
    desc: è®¾ç½®å¼€å‘ç¯å¢ƒ
    cmds:
      - task: deps
      - task: install-hooks
      - echo "âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"

  dev-test:
    desc: å¼€å‘æ—¶å¿«é€Ÿæµ‹è¯•
    cmds:
      - task: fmt
      - task: vet
      - task: test

  dev-build:
    desc: å¼€å‘æ—¶æ„å»ºæµ‹è¯• (é™æ€ç¼–è¯‘)
    cmds:
      - task: build
      - echo "âœ… æ„å»ºå®Œæˆï¼Œå¯æ‰§è¡Œæ–‡ä»¶åœ¨ dist/ ç›®å½•"

  # === éªŒè¯å’Œå¯¹æ¯” ===
  verify-static-build:
    desc: éªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦ä¸ºé™æ€ç¼–è¯‘
    cmds:
      - task: build
      - |
        echo "ğŸ” éªŒè¯é™æ€ç¼–è¯‘..."
        BINARY_PATH=$(find dist/ -name "hwcctl*" -type f | head -1)
        if [ -z "$BINARY_PATH" ]; then
          echo "âŒ æ‰¾ä¸åˆ°æ„å»ºäº§ç‰©"
          exit 1
        fi
        echo "ğŸ“ æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶: $BINARY_PATH"

        # æ£€æŸ¥åŠ¨æ€é“¾æ¥åº“ä¾èµ–
        if command -v ldd >/dev/null 2>&1; then
          echo "ğŸ“‹ åŠ¨æ€é“¾æ¥åº“ä¾èµ–æ£€æŸ¥:"
          LDD_OUTPUT=$(ldd "$BINARY_PATH" 2>&1 || true)
          if echo "$LDD_OUTPUT" | grep -q "not a dynamic executable"; then
            echo "âœ… é™æ€ç¼–è¯‘ç¡®è®¤: æ— åŠ¨æ€é“¾æ¥åº“ä¾èµ–"
          else
            echo "âš ï¸  å¯èƒ½å­˜åœ¨åŠ¨æ€é“¾æ¥ä¾èµ–:"
            echo "$LDD_OUTPUT"
          fi
        else
          echo "â„¹ï¸  ldd å‘½ä»¤ä¸å¯ç”¨ï¼Œè·³è¿‡åŠ¨æ€é“¾æ¥æ£€æŸ¥"
        fi

        # æ£€æŸ¥æ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
        file "$BINARY_PATH"
        ls -lh "$BINARY_PATH"

  show-build-config:
    desc: æ˜¾ç¤ºå½“å‰æ„å»ºé…ç½®
    cmds:
      - echo "ğŸ“‹ GoReleaser æ„å»ºé…ç½®:"
      - echo "================================"
      - grep -A 20 "builds:" .goreleaser.yaml
      - echo ""
      - echo "âœ… æ‰€æœ‰æ„å»ºä»»åŠ¡ç»Ÿä¸€ä½¿ç”¨ GoReleaser"
      - echo "âœ… é™æ€ç¼–è¯‘å·²å¯ç”¨ (CGO_ENABLED=0)"
